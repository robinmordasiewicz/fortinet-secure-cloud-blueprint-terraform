---
name: 'tf-plan-apply-destroy.yml'

on:
  workflow_dispatch:
  push:
    branches:
      - '*'
      - '!main'

jobs:
  apply-or-destroy:
    name: 'apply or destroy'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
    outputs:
      action: ${{ steps.action.outputs.action }}
    steps:
      - name: Set Action Deployed true or false
        run: |
          if [ ${{ vars.DEPLOYED == "true" }} ]; then
            echo "action=apply" >> $GITHUB_OUTPUT
          else
            echo "action=destroy" >> $GITHUB_OUTPUT
          fi

  terraform-apply:
    needs: [apply-or-destroy]
    if: ${{ env.action == 'apply' }}
    name: 'apply'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}

    steps:
      - name: debug
        run: env

  terraform-destroy:
    needs: [apply-or-destroy]
    if: ${{ env.action == 'destroy' }}
    name: 'destroy'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}

    steps:
      - name: debug
        run: env
